<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –ù–µ–∫—Å—É—Å–∞: 3D –°–∏–º—É–ª—è—Ç–æ—Ä</title>
    <!-- Chosen Palette: Deep Slate Harmony (—Ç–µ–º–Ω–æ-—Å–µ—Ä—ã–π —Ñ–æ–Ω, –∑–æ–ª–æ—Ç—ã–µ –∏ –∞–∫—Ü–µ–Ω—Ç–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã) -->
    <!-- Application Structure Plan: –û–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–∞—è 3D –∏–≥—Ä–∞. –°—Ç—Ä—É–∫—Ç—É—Ä–∞: 1. –•–æ–ª—Å—Ç –¥–ª—è 3D-—Å—Ü–µ–Ω—ã (three.js) –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à—É—é —á–∞—Å—Ç—å —ç–∫—Ä–∞–Ω–∞. 2. –ü–∞–Ω–µ–ª—å UI (HTML/Tailwind) –ø–æ–≤–µ—Ä—Ö —Ö–æ–ª—Å—Ç–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–≥—Ä—ã (—Ä–µ—Å—É—Ä—Å—ã, —É–∑–ª—ã, —Ü–µ–ª—å) –∏ –ª–æ–≥–∞ –¥–µ–π—Å—Ç–≤–∏–π. 3. –í–≤–æ–¥–Ω—ã–µ –∏ –∏–≥—Ä–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (HTML/JS) –¥–ª—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π, –ø–æ–±–µ–¥—ã/–ø–æ—Ä–∞–∂–µ–Ω–∏—è. 4. –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–π (–∫–ª–∞–≤–∏—à–∏ WASD –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è) –∏ –∫–∞–º–µ—Ä–æ–π (–º—ã—à—å –¥–ª—è –≤—Ä–∞—â–µ–Ω–∏—è –∏ –∑—É–º–∞). –≠—Ç–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–ª–Ω–æ–µ –ø–æ–≥—Ä—É–∂–µ–Ω–∏–µ –≤ 3D-–º–∏—Ä, –ø—Ä–∏ —ç—Ç–æ–º –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—è –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –∏–≥—Ä–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏ —á–µ—Ç–∫—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å. -->
    <!-- Visualization & Content Choices: 1. 3D-–º–∏—Ä: three.js –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ü–µ–Ω—ã —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º–∏ –≤–∏–∑—É–∞–ª—å–Ω—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏. –ò–≥—Ä–æ–∫ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω –∫–∞–ø—Å—É–ª–æ–π. –†–µ—Å—É—Ä—Å—ã - —Å–≤–µ—Ç—è—â–∏–µ—Å—è –∫—É–±—ã. –£–∑–ª—ã —Å–µ—Ç–∏ - —è—Ä–∫–æ-–∑–µ–ª–µ–Ω—ã–µ –æ–∫—Ç–∞—ç–¥—Ä—ã. –õ–∏–Ω–∏–∏ —Å–≤—è–∑–∏ –º–µ–∂–¥—É —É–∑–ª–∞–º–∏. –î–æ–±–∞–≤–ª–µ–Ω—ã —Ñ–æ–Ω–æ–≤—ã–µ –∑–≤–µ–∑–¥—ã –¥–ª—è –≥–ª—É–±–∏–Ω—ã. –¶–µ–ª—å - —Å–æ–∑–¥–∞—Ç—å –æ—â—É—â–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ, –¥–∏–Ω–∞–º–∏—á–Ω–æ —Ä–∞–∑–≤–∏–≤–∞—é—â–µ–≥–æ—Å—è –º–∏—Ä–∞. 2. UI: HTML/Tailwind –¥–ª—è –æ–≤–µ—Ä–ª–µ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –ª–æ–≥–∞ –¥–µ–π—Å—Ç–≤–∏–π. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∏—Å–µ–ª –∏ —Å–æ–æ–±—â–µ–Ω–∏–π. –¶–µ–ª—å - –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å —á–µ—Ç–∫—É—é, –º–≥–Ω–æ–≤–µ–Ω–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ –∏ —Å–æ–±—ã—Ç–∏—è—Ö. 3. –ö–∞–º–µ—Ä–∞: Three.js OrbitControls –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤—Ä–∞—â–µ–Ω–∏—è –∏ –∑—É–º–∞, –∞ —Ç–∞–∫–∂–µ —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∑–∞ –∏–≥—Ä–æ–∫–æ–º –¥–ª—è –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ–≥–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è. –¶–µ–ª—å - —É–ª—É—á—à–∏—Ç—å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ 3D-–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞. 4. –ò–≥—Ä–æ–≤–æ–π –ø—Ä–æ—Ü–µ—Å—Å: JavaScript –¥–ª—è –ª–æ–≥–∏–∫–∏ –¥–≤–∏–∂–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞, –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π, –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ —É–∑–ª–æ–≤, –∞ —Ç–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ª–æ–≤–∏–π –ø–æ–±–µ–¥—ã/–ø–æ—Ä–∞–∂–µ–Ω–∏—è. –¶–µ–ª—å - —Å–æ–∑–¥–∞—Ç—å –ø–æ–Ω—è—Ç–Ω—ã–π –∏ –≤–æ–≤–ª–µ–∫–∞—é—â–∏–π —Ü–∏–∫–ª "—Å–æ–±–µ—Ä–∏-–ø–æ—Å—Ç—Ä–æ–π" —Å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏. 5. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ SVG/Mermaid: –í—Å–µ –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ three.js –∏–ª–∏ HTML/CSS. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* tailwind dark gray-900 */
            overflow: hidden;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        canvas {
            display: block;
            position: fixed; /* –ß—Ç–æ–±—ã —Ö–æ–ª—Å—Ç –≤—Å–µ–≥–¥–∞ –∑–∞–ø–æ–ª–Ω—è–ª –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 0;
        }
        #game-ui {
            position: fixed; /* –î–ª—è –Ω–∞–ª–æ–∂–µ–Ω–∏—è –ø–æ–≤–µ—Ä—Ö —Ö–æ–ª—Å—Ç–∞ */
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10; /* –í—ã—à–µ —Ö–æ–ª—Å—Ç–∞ */
            background-color: rgba(30, 41, 59, 0.9); /* slate-800 —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
            color: #E2E8F0; /* gray-200 */
            width: 95%;
            max-width: 800px;
            margin: auto;
            border: 1px solid #4A5568; /* gray-700 */
        }
        .accent-gold {
            color: #D4AF37;
        }
        .bg-accent-gold {
            background-color: #D4AF37;
        }
        .text-shadow {
            text-shadow: 1px 1px 3px rgba(0,0,0,0.4);
        }
        .info-box {
            background-color: rgba(0, 0, 0, 0.85); /* –ë–æ–ª–µ–µ —Ç–µ–º–Ω—ã–π –æ–≤–µ—Ä–ª–µ–π –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π */
            border-radius: 0.5rem;
            padding: 2rem;
            color: #CBD5E0; /* gray-300 */
            position: fixed; /* –ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 20; /* –í—ã—à–µ UI */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        #game-log {
            background-color: rgba(17, 24, 39, 0.7); /* gray-900 —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é */
            border: 1px solid #4A5568;
            max-height: 120px; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –ª–æ–≥–∞ */
            overflow-y: auto; /* –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É, –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –º–Ω–æ–≥–æ */
        }
        #game-log li {
            padding: 0.25rem 0;
        }
    </style>
</head>
<body>
    <div id="game-ui" class="flex flex-col md:flex-row justify-between items-start md:items-center p-6 rounded-xl shadow-xl space-y-4 md:space-y-0 md:space-x-8">
        <div class="flex-1 text-center md:text-left">
            <h1 class="text-3xl font-extrabold accent-gold text-shadow mb-2">–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –ù–µ–∫—Å—É—Å–∞</h1>
            <p class="text-lg text-gray-300">–ü–æ—Å—Ç—Ä–æ–π—Ç–µ –î–µ—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é –°–µ—Ç—å</p>
        </div>
        <div class="flex-1 grid grid-cols-2 gap-4 text-center">
            <div>
                <p class="text-gray-400 text-sm">–†–µ—Å—É—Ä—Å—ã ‚ö°</p>
                <p id="resource-count" class="text-3xl font-bold accent-gold text-shadow">0</p>
            </div>
            <div>
                <p class="text-gray-400 text-sm">–£–∑–ª—ã –°–µ—Ç–∏ üåê</p>
                <p id="node-count" class="text-3xl font-bold text-white text-shadow">0 / 20</p>
            </div>
        </div>
        <div class="flex-1 text-center md:text-right mt-4 md:mt-0">
            <button id="restart-button" class="px-6 py-3 bg-accent-gold text-gray-900 font-bold rounded-full shadow-lg hover:bg-yellow-600 transition-colors transform hover:scale-105">
                –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
            </button>
        </div>
        
        <div id="game-log-container" class="mt-4 w-full text-center">
            <h3 class="text-lg font-semibold text-gray-200 mb-2">–õ–æ–≥ –î–µ–π—Å—Ç–≤–∏–π:</h3>
            <ul id="game-log" class="bg-gray-900/70 p-4 rounded-lg shadow-inner text-sm text-gray-400">
                <li>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Nexus Prime!</li>
            </ul>
        </div>

        <div id="game-message" class="info-box hidden">
            <p id="message-text" class="text-white text-2xl md:text-3xl font-bold mb-4"></p>
            <p id="instruction-text" class="text-gray-300 text-md md:text-lg mb-6">
                –¶–µ–ª—å: –°–æ–±–µ—Ä–∏—Ç–µ 20 —É–∑–ª–æ–≤. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ WASD –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è, –º—ã—à—å –¥–ª—è –≤—Ä–∞—â–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã.
            </p>
            <button id="start-game-button" class="px-8 py-4 bg-accent-gold text-gray-900 font-bold rounded-full shadow-lg hover:bg-yellow-600 transition-colors transform hover:scale-105">
                –ù–∞—á–∞—Ç—å –∏–≥—Ä—É
            </button>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Three.js
        let scene, camera, renderer, controls;
        let player;
        const resources = [];
        const networkNodes = [];
        const networkLines = [];

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        let gameActive = false;
        let collectedResources = 0;
        const targetNodes = 20; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–∑–ª–æ–≤ –¥–ª—è –ø–æ–±–µ–¥—ã
        const resourcesPerNode = 3; // –°–∫–æ–ª—å–∫–æ —Ä–µ—Å—É—Ä—Å–æ–≤ –Ω—É–∂–Ω–æ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–π–∫–∏ –æ–¥–Ω–æ–≥–æ —É–∑–ª–∞

        // –≠–ª–µ–º–µ–Ω—Ç—ã UI
        const resourceCountEl = document.getElementById('resource-count');
        const nodeCountEl = document.getElementById('node-count');
        const gameMessageEl = document.getElementById('game-message');
        const messageTextEl = document.getElementById('message-text');
        const instructionTextEl = document.getElementById('instruction-text');
        const startGameButton = document.getElementById('start-game-button');
        const restartButton = document.getElementById('restart-button');
        const gameLogEl = document.getElementById('game-log'); // –î–æ–±–∞–≤–ª–µ–Ω–æ: –ª–æ–≥ –¥–µ–π—Å—Ç–≤–∏–π

        // –î–≤–∏–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
        const keys = { w: false, a: false, s: false, d: false };
        const playerSpeed = 0.5;

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ü–µ–Ω—ã ---
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a202c); // –¢–µ–º–Ω—ã–π —Ñ–æ–Ω

            // –ö–∞–º–µ—Ä–∞
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 20, 40); // –ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –∫–∞–º–µ—Ä—ã, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –ø–æ–ª–µ

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            // OrbitControls –¥–ª—è –∫–∞–º–µ—Ä—ã
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; // –î–ª—è –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã
            controls.dampingFactor = 0.05;
            controls.screenSpacePanning = false;
            controls.maxPolarAngle = Math.PI * 0.45; // –ó–∞–ø—Ä–µ—â–∞–µ–º –∫–∞–º–µ—Ä–µ —É—Ö–æ–¥–∏—Ç—å –ø–æ–¥ –∑–µ–º–ª—é
            controls.target.set(0, 1.5, 0); // –§–æ–∫—É—Å –∫–∞–º–µ—Ä—ã –Ω–∞ –∏–≥—Ä–æ–∫–µ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ)

            // –ò–≥—Ä–æ–∫ (–Ø–¥—Ä–æ) - —Ç–µ–ø–µ—Ä—å –∫–∞–ø—Å—É–ª–∞
            const playerGeometry = new THREE.CapsuleGeometry(1, 2, 8, 16); // –†–∞–¥–∏—É—Å, –≤—ã—Å–æ—Ç–∞, —Å–µ–≥–º–µ–Ω—Ç—ã
            const playerMaterial = new THREE.MeshLambertMaterial({ color: 0xD4AF37 }); // –ó–æ–ª–æ—Ç–æ–π —Ü–≤–µ—Ç
            player = new THREE.Mesh(playerGeometry, playerMaterial);
            player.position.set(0, 1.5, 0); // –ù–µ–º–Ω–æ–≥–æ –Ω–∞–¥ –∑–µ–º–ª–µ–π
            scene.add(player);

            // –ü–ª–æ—Å–∫–æ—Å—Ç—å –∑–µ–º–ª–∏
            const planeGeometry = new THREE.PlaneGeometry(100, 100);
            const planeMaterial = new THREE.MeshLambertMaterial({ color: 0x2d3748, side: THREE.DoubleSide });
            const plane = new THREE.Mesh(planeGeometry, planeMaterial);
            plane.rotation.x = Math.PI / 2;
            plane.position.y = 0;
            scene.add(plane);

            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Å–µ—Ç–∫–∞ –Ω–∞ –ø–ª–æ—Å–∫–æ—Å—Ç–∏
            const gridHelper = new THREE.GridHelper(100, 100, 0x444444, 0x444444);
            scene.add(gridHelper);

            // –û—Å–≤–µ—â–µ–Ω–∏–µ
            const ambientLight = new THREE.AmbientLight(0x404040, 2); // –ú—è–≥–∫–∏–π –±–µ–ª—ã–π —Å–≤–µ—Ç, —É–≤–µ–ª–∏—á–µ–Ω–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.2); // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Å–≤–µ—Ç
            directionalLight.position.set(10, 20, 10);
            scene.add(directionalLight);

            // –§–æ–Ω–æ–≤—ã–µ –∑–≤–µ–∑–¥—ã
            const starGeometry = new THREE.BufferGeometry();
            const starMaterial = new THREE.PointsMaterial({ color: 0xFFFFFF, size: 0.1 });
            const starVertices = [];
            for (let i = 0; i < 5000; i++) {
                const x = (Math.random() - 0.5) * 1000;
                const y = (Math.random() - 0.5) * 1000;
                const z = (Math.random() - 0.5) * 1000;
                starVertices.push(x, y, z);
            }
            starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
            const stars = new THREE.Points(starGeometry, starMaterial);
            scene.add(stars);

            spawnResources(15); // –ù–∞—á–∞–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

            window.addEventListener('resize', onWindowResize);
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);

            resetGame(); // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã –∏ UI
            showGameMessage('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –ù–µ–∫—Å—É—Å–∞!', '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ WASD –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è, –º—ã—à—å –¥–ª—è –≤—Ä–∞—â–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã. –¶–µ–ª—å: –ø–æ—Å—Ç—Ä–æ–π—Ç–µ 20 –£–∑–ª–æ–≤ –°–µ—Ç–∏.');
        }

        // --- –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª ---
        function animate() {
            requestAnimationFrame(animate);

            if (gameActive) {
                // –î–≤–∏–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
                const moveAmount = playerSpeed;
                const rotation = camera.getWorldDirection(new THREE.Vector3()); // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
                rotation.y = 0; // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é —Å–æ—Å—Ç–∞–≤–ª—è—é—â—É—é, —á—Ç–æ–±—ã –Ω–µ –ª–µ—Ç–∞—Ç—å
                rotation.normalize();

                if (keys.w) player.position.addScaledVector(rotation, -moveAmount); // –î–≤–∏–≥–∞–µ–º—Å—è –≤–ø–µ—Ä–µ–¥ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é –∫–∞–º–µ—Ä—ã
                if (keys.s) player.position.addScaledVector(rotation, moveAmount); // –î–≤–∏–≥–∞–µ–º—Å—è –Ω–∞–∑–∞–¥
                
                const sidewaysRotation = new THREE.Vector3().crossVectors(camera.up, rotation).normalize();
                if (keys.a) player.position.addScaledVector(sidewaysRotation, -moveAmount); // –î–≤–∏–≥–∞–µ–º—Å—è –≤–ª–µ–≤–æ
                if (keys.d) player.position.addScaledVector(sidewaysRotation, moveAmount); // –î–≤–∏–≥–∞–µ–º—Å—è –≤–ø—Ä–∞–≤–æ

                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏–≥—Ä–æ–∫–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –∫–∞—Ä—Ç—ã
                const mapLimit = 49;
                player.position.x = Math.max(-mapLimit, Math.min(mapLimit, player.position.x));
                player.position.z = Math.max(-mapLimit, Math.min(mapLimit, player.position.z));
                
                checkCollisions();
            }

            controls.target.copy(player.position); // –ö–∞–º–µ—Ä–∞ –≤—Å–µ–≥–¥–∞ —Å–ª–µ–¥—É–µ—Ç –∑–∞ –∏–≥—Ä–æ–∫–æ–º
            controls.update(); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –∫–∞–º–µ—Ä—ã
            renderer.render(scene, camera);
        }

        // --- –õ–æ–≥–∏–∫–∞ –∏–≥—Ä—ã ---
        function spawnResources(count) {
            for (let i = 0; i < count; i++) {
                const geometry = new THREE.BoxGeometry(1, 1, 1);
                // –°–≤–µ—Ç—è—â–∏–π—Å—è –º–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è —Ä–µ—Å—É—Ä—Å–æ–≤
                const material = new THREE.MeshStandardMaterial({
                    color: 0x00FFFF, // –Ø—Ä–∫–∏–π –≥–æ–ª—É–±–æ–π
                    emissive: 0x00FFFF, // –¶–≤–µ—Ç —Å–≤–µ—á–µ–Ω–∏—è
                    emissiveIntensity: 0.5 // –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —Å–≤–µ—á–µ–Ω–∏—è
                });
                const resource = new THREE.Mesh(geometry, material);
                resource.position.set(
                    (Math.random() - 0.5) * 90, // –®–∏—Ä–µ –æ–±–ª–∞—Å—Ç—å —Å–ø–∞–≤–Ω–∞
                    0.5,
                    (Math.random() - 0.5) * 90
                );
                scene.add(resource);
                resources.push(resource);
            }
        }

        function checkCollisions() {
            const playerBox = new THREE.Box3().setFromObject(player);

            for (let i = resources.length - 1; i >= 0; i--) {
                const resource = resources[i];
                const resourceBox = new THREE.Box3().setFromObject(resource);

                if (playerBox.intersectsBox(resourceBox)) {
                    scene.remove(resource);
                    resources.splice(i, 1);
                    collectedResources++;
                    updateUIStats();
                    addLog(`‚ö° –°–æ–±—Ä–∞–Ω –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –û—Å–∫–æ–ª–æ–∫! (${collectedResources})`);

                    if (collectedResources % resourcesPerNode === 0) {
                        buildNetworkNode();
                    }
                    spawnResources(1); // –ü–æ—Ä–æ–∂–¥–∞–µ–º –Ω–æ–≤—ã–π —Ä–µ—Å—É—Ä—Å –ø–æ—Å–ª–µ —Å–±–æ—Ä–∞
                }
            }
        }

        function buildNetworkNode() {
            if (networkNodes.length >= targetNodes) return; // –ù–µ —Å—Ç—Ä–æ–∏–º –±–æ–ª—å—à–µ —Ü–µ–ª–∏

            const nodeGeometry = new THREE.OctahedronGeometry(1.2); // –û–∫—Ç–∞—ç–¥—Ä –¥–ª—è —É–∑–ª–∞
            const nodeMaterial = new THREE.MeshLambertMaterial({ color: 0x00FF00 }); // –Ø—Ä–∫–æ-–∑–µ–ª–µ–Ω—ã–π
            const newNode = new THREE.Mesh(nodeGeometry, nodeMaterial);

            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —É–∑–µ–ª —Ä—è–¥–æ–º —Å –∏–≥—Ä–æ–∫–æ–º, –Ω–æ —Å –Ω–µ–±–æ–ª—å—à–∏–º —Å–º–µ—â–µ–Ω–∏–µ–º
            const offset = new THREE.Vector3(
                (Math.random() - 0.5) * 20, // –ë–æ–ª—å—à–µ —Ä–∞–¥–∏—É—Å —Å–º–µ—â–µ–Ω–∏—è
                1.5,
                (Math.random() - 0.5) * 20
            );
            newNode.position.copy(player.position).add(offset);
            newNode.position.y = 1.5; // –£–∑–ª—ã —á—É—Ç—å –≤—ã—à–µ –∑–µ–º–ª–∏
            scene.add(newNode);
            networkNodes.push(newNode);
            addLog(`üåê –ü–æ—Å—Ç—Ä–æ–µ–Ω –£–∑–µ–ª –°–µ—Ç–∏! (${networkNodes.length}/${targetNodes})`);
            updateUIStats();

            // –°–æ–µ–¥–∏–Ω—è–µ–º —Å –±–ª–∏–∂–∞–π—à–∏–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —É–∑–ª–æ–º, –µ—Å–ª–∏ –µ—Å—Ç—å
            if (networkNodes.length > 1) {
                let closestNode = null;
                let minDist = Infinity;
                for (const node of networkNodes) {
                    if (node !== newNode) {
                        const dist = newNode.position.distanceTo(node.position);
                        if (dist < minDist) {
                            minDist = dist;
                            closestNode = node;
                        }
                    }
                }
                if (closestNode && minDist < 40) { // –£–≤–µ–ª–∏—á–µ–Ω–∞ –¥–∏—Å—Ç–∞–Ω—Ü–∏—è –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                    const lineMaterial = new THREE.LineBasicMaterial({ color: 0x8888FF, linewidth: 3 }); // –ë–æ–ª–µ–µ —Ç–æ–ª—Å—Ç–∞—è —Å–∏–Ω—è—è –ª–∏–Ω–∏—è
                    const points = [];
                    points.push(newNode.position.clone());
                    points.push(closestNode.position.clone());
                    const lineGeometry = new THREE.BufferGeometry().setFromPoints(points);
                    const line = new THREE.Line(lineGeometry, lineMaterial);
                    scene.add(line);
                    networkLines.push(line);
                }
            }

            checkWinCondition();
        }

        function checkWinCondition() {
            if (networkNodes.length >= targetNodes) {
                showGameMessage('–ü–û–ë–ï–î–ê, –ê–†–•–ò–¢–ï–ö–¢–û–†!', '–í—ã —É—Å–ø–µ—à–Ω–æ –ø–æ—Å—Ç—Ä–æ–∏–ª–∏ –î–µ—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é –°–µ—Ç—å! –ë—É–¥—É—â–µ–µ –≤ –≤–∞—à–∏—Ö —Ä—É–∫–∞—Ö.');
                gameActive = false;
            }
        }

        // --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI ---
        function updateUIStats() {
            resourceCountEl.textContent = collectedResources;
            nodeCountEl.textContent = `${networkNodes.length} / ${targetNodes}`;
        }

        function addLog(message) {
            const logItem = document.createElement('li');
            logItem.textContent = message;
            gameLogEl.prepend(logItem); // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
            if (gameLogEl.children.length > 5) { // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
                gameLogEl.removeChild(gameLogEl.lastChild);
            }
        }

        // --- –°–æ–æ–±—â–µ–Ω–∏—è –∏–≥—Ä—ã (–Ω–∞—á–∞–ª–æ/–∫–æ–Ω–µ—Ü) ---
        function showGameMessage(title, instructions) {
            messageTextEl.textContent = title;
            instructionTextEl.textContent = instructions;
            gameMessageEl.classList.remove('hidden');
            startGameButton.classList.remove('hidden');
            restartButton.classList.add('hidden'); // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ä–µ—Å—Ç–∞—Ä—Ç–∞ –≤ –Ω–∞—á–∞–ª—å–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
        }

        function hideGameMessage() {
            gameMessageEl.classList.add('hidden');
            startGameButton.classList.add('hidden');
            restartButton.classList.remove('hidden'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ä–µ—Å—Ç–∞—Ä—Ç–∞ –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã
        }

        // --- –°–±—Ä–æ—Å –∏–≥—Ä—ã ---
        function resetGame() {
            gameActive = false;
            collectedResources = 0;
            updateUIStats();

            // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å–æ —Å—Ü–µ–Ω—ã
            resources.forEach(res => scene.remove(res));
            resources.length = 0;
            networkNodes.forEach(node => scene.remove(node));
            networkNodes.length = 0;
            networkLines.forEach(line => scene.remove(line));
            networkLines.length = 0;

            player.position.set(0, 1.5, 0); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∏–≥—Ä–æ–∫–∞
            controls.target.set(0, 1.5, 0); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ–∫—É—Å –∫–∞–º–µ—Ä—ã
            camera.position.set(0, 20, 40); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∫–∞–º–µ—Ä—ã

            spawnResources(15); // –ó–∞–Ω–æ–≤–æ –ø–æ—Ä–æ–∂–¥–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã
            updateUIStats(); // –û–±–Ω–æ–≤–ª—è–µ–º UI
        }

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function onKeyDown(event) {
            keys[event.key.toLowerCase()] = true;
        }

        function onKeyUp(event) {
            keys[event.key.toLowerCase()] = false;
        }

        startGameButton.addEventListener('click', () => {
            hideGameMessage();
            gameActive = true;
            controls.target.copy(player.position); // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–∞–º–µ—Ä–∞ —Å–ª–µ–¥—É–µ—Ç –∑–∞ –∏–≥—Ä–æ–∫–æ–º
        });

        restartButton.addEventListener('click', () => {
            resetGame();
            showGameMessage('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –ù–µ–∫—Å—É—Å–∞!', '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ WASD –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è, –º—ã—à—å –¥–ª—è –≤—Ä–∞—â–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã. –¶–µ–ª—å: –ø–æ—Å—Ç—Ä–æ–π—Ç–µ 20 –£–∑–ª–æ–≤ –°–µ—Ç–∏.');
        });

        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ–∫–Ω–∞
        window.onload = function () {
            init();
            animate();
        };
    </script>
</body>
</html>
